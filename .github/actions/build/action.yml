name: Build EDK2 UEFI firmware
description: Build the firmware

inputs:
  version:
    description: Firmware version
    required: true

runs:
  using: composite
  steps:
  - name: Set up Linux environment
    run: sudo apt install acpica-tools gcc-aarch64-linux-gnu python3-distutils uuid-dev
    shell: bash
  - name: Check out EDK2 submodules
    run: git submodule update --init --recursive
    shell: bash
  - name: Patch EDK2 repositories
    run: |
      patch --binary -d edk2 -p1 -i ../patches/edk2/0001-MdeModulePkg-UefiBootManagerLib-Signal-ReadyToBoot-o.patch
      patch --binary -d edk2-platforms -p1 -i ../patches/edk2-platforms/0001-BcmGenetDxe-Delay-for-linkup-in-transmit.patch
      patch --binary -d edk2-platforms -p1 -i ../patches/edk2-platforms/0002-Platform-RaspberryPi-Increase-genet-dma-window.patch
    shell: bash
  - name: Set up EDK2
    run: make -C edk2/BaseTools
    shell: bash
  - name: Build UEFI firmware
    run: |
      export WORKSPACE=$PWD
      export PACKAGES_PATH=$WORKSPACE/edk2:$WORKSPACE/edk2-platforms:$WORKSPACE/edk2-non-osi
      export GCC5_AARCH64_PREFIX=aarch64-linux-gnu-
      export BUILD_FLAGS="-D SECURE_BOOT_ENABLE=TRUE -D INCLUDE_TFTP_COMMAND=TRUE -D NETWORK_ISCSI_ENABLE=TRUE"
      source edk2/edksetup.sh
      # EDK2's 'build' command doesn't play nice with spaces in environmnent variables, so we can't move the PCDs there...
      build -a AARCH64 -t GCC5 -p edk2-platforms/Platform/RaspberryPi/RPi4/RPi4.dsc -b DEBUG --pcd gEfiMdeModulePkgTokenSpaceGuid.PcdFirmwareVendor=L"https://github.com/pftf/RPi4" --pcd gEfiMdeModulePkgTokenSpaceGuid.PcdFirmwareVersionString=L"UEFI Firmware ${{inputs.version}}" ${BUILD_FLAGS}
      build -a AARCH64 -t GCC5 -p edk2-platforms/Platform/RaspberryPi/RPi4/RPi4.dsc -b RELEASE --pcd gEfiMdeModulePkgTokenSpaceGuid.PcdFirmwareVendor=L"https://github.com/pftf/RPi4" --pcd gEfiMdeModulePkgTokenSpaceGuid.PcdFirmwareVersionString=L"UEFI Firmware ${{inputs.version}}" ${BUILD_FLAGS}
      cp Build/RPi4/RELEASE_GCC5/FV/RPI_EFI.fd .
    shell: bash
